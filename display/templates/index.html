<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CleanBite | Map Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        /* General layout styles */
        body { background-color: #f7f7f7; }
        .main-container-box {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        /* Map area (Leaflet) */
        #map {
            height: 800px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #e9e9e9;
            border: 2px solid #ddd;
        }
        
        /* SCROLLABLE BUTTONS CONTAINER STYLES */
        .filter-scroll-container {
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-bottom: 10px;
        }
        .filter-scroll-container::-webkit-scrollbar {
            display: none;
        }
        .filter-no-wrap {
            flex-wrap: nowrap !important;
        }
        
        /* === START NEW BUTTON STYLES === */
        
        /* Filter Button Styles (Dark Green Theme) */
        .quick-filter-button {
        border-radius: 10px; /* Slightly larger radius */
        
        /* FONT CHANGES */
        font-family: 'Arial';
        font-weight: 700; 
        font-size: 1.15rem; /* Further increased size */
        
        /* SIZE AND SPACING CHANGES */
        padding: 1rem 1.5rem; /* Increased vertical and horizontal padding for much larger hit area */
        margin-right: 12px;
        min-height: 70px; /* Increased min-height for uniform look */
        
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        flex-shrink: 0;
        
        background-color: #2a3d3d; 
        color: #ced4da; 
        border: 1px solid #2a3d3d; 
        transition: all 0.2s ease;
        }

        .quick-filter-button:hover {
            background-color: #3a4d4d;
            color: #ffffff;
            border-color: #3a4d4d;
        }

        /* ACTIVE FILTER STYLE */
        .filter-active {
            background-color: #28a745 !important;
            color: white !important; 
            border-color: #28a745 !important;
            box-shadow: none !important;
        }
        
        /* === END NEW BUTTON STYLES === */
        
        /* RESTAURANT CARD STYLES */
        .restaurant-card { 
            margin-bottom: 12px; 
            border-radius: 8px; 
            overflow: hidden; 
            height: 100px; 
            display: flex; 
            align-items: stretch;
            border: 1px solid #ddd;
        }

        /* Grade/Image Column */
        .grade-banner {
            height: 100px; 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 0;
            padding: 0; 
            background: none;
        }
        .grade-banner img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
        }

        /* Text prominence */
        .card-title-dba {
            font-size: 1.2rem; 
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        /* Alignment */
        .restaurant-row {
            width: 100%;
            margin: 0;
            align-items: center; 
        }
        
        /* Card Body */
        .card-body-content {
            display: flex;
            flex-direction: column;
            justify-content: center; 
            height: 100%; 
            padding: 10px 15px; 
            flex-grow: 1;
        }

        .restaurant-card:hover {
            background-color: #f9f9f9;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
    </style>
</head>
<body>
    
<header class="container-fluid bg-white p-3 mb-4 border-bottom">
    <div class="d-flex justify-content-between align-items-center container">
        
        <form class="col-lg-6 col-md-8 me-4 ms-0" method="get" action="/restaurants">
            
            <div class="input-group">
                <input type="text" class="form-control" name="search"
                        placeholder="Search by Restaurant Name, Cuisine, or Address..."
                        value="{{ search or '' }}">
                
                {# Hidden fields to preserve existing filters #}
                {% if borough %} <input type="hidden" name="borough" value="{{ borough }}"> {% endif %}
                {% if cuisine %} <input type="hidden" name="cuisine" value="{{ cuisine }}"> {% endif %}
                {% if grade %} <input type="hidden" name="grade" value="{{ grade }}"> {% endif %}
                
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </form>
        
        <h1 class="h3 mb-0 text-nowrap">CleanBite</h1>
    </div>
</header> 

    <div class="container main-container-box">
        <div class="row">
            
            <div class="col-md-7">
                <div id="map"></div>
            </div>

            <div class="col-md-5">

                <h6 class="mt-0 mb-3 text-muted">Boroughs</h6>
                <div class="filter-scroll-container mb-4">
                    <div class="d-flex filter-no-wrap">
                        {# Preserve other filters: cuisine, grade #}
                        {% set current_other_params = '&cuisine=' + cuisine if cuisine else '' %}
                        {% set current_other_params = current_other_params + ('&grade=' + grade if grade else '') %}
                        
                        {% set boroughs = ['Manhattan', 'Queens', 'Brooklyn', 'Bronx', 'Staten Island'] %}
                        {% for boro in boroughs %}
                            <a href="/restaurants?borough={{ boro }}{{ current_other_params }}" 
                               class="quick-filter-button {% if borough and borough|lower == boro|lower %}filter-active{% endif %}">
                               {{ boro }}
                            </a>
                        {% endfor %}
                    </div>
                </div>

                <h6 class="mt-4 mb-3 text-muted">Cuisine</h6>
                <div class="filter-scroll-container mb-4">
                    <div class="d-flex filter-no-wrap">
                        {# Preserve other filters: borough, grade #}
                        {% set current_other_params = '&borough=' + borough if borough else '' %}
                        {% set current_other_params = current_other_params + ('&grade=' + grade if grade else '') %}
                        
                        {% set cuisines = ['Italian', 'Japanese', 'Indian', 'American', 'Chinese', 'Mexican'] %}
                        {% for c in cuisines %}
                            <a href="/restaurants?cuisine={{ c }}{{ current_other_params }}" 
                               class="quick-filter-button {% if cuisine and cuisine|lower == c|lower %}filter-active{% endif %}">
                               {{ c }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="row mb-4 g-2">
                    <div class="col-6">
                        <a href="/restaurants" class="btn btn-outline-danger w-100">
                            <i class="bi bi-x-circle"></i> Clear Filters
                        </a>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasFilters" aria-controls="offcanvasFilters">
                            <i class="bi bi-sliders"></i> More Filters
                        </button>
                    </div>
                </div>
                <h6 class="mt-4 mb-3 text-muted border-top pt-3">Restaurant List (Showing up to 100 results)</h6>
                
                <div class="restaurant-list-container" style="max-height: 680px; overflow-y: auto;">
                    {% for rest in data %}
                        {% set grade_val = rest.GRADE or 'N/A' %}
                        
                        {# Logic to set the image path #}
                        {% set grade_img_src = 'pending.jpeg' %}
                        {% if grade_val == 'A' %}{% set grade_img_src = 'A.jpeg' %}
                        {% elif grade_val == 'B' %}{% set grade_img_src = 'B.jpeg' %}
                        {% elif grade_val == 'C' %}{% set grade_img_src = 'C.jpeg' %}
                        {% elif grade_val == 'Z' %}{% set grade_img_src = 'pending.jpeg' %}
                        {% endif %}

                        <a href="/restaurant/{{ rest.CAMIS }}" class="text-decoration-none text-dark" style="display:block;">
                        <div class="card restaurant-card shadow-sm" style="cursor:pointer;">
                            <div class="row g-0 restaurant-row">
                                <div class="col-10">
                                    <div class="card-body py-2 px-3 card-body-centered">
                                        <h6 class="card-title card-title-dba text-truncate mb-1">{{ rest.DBA | replace('**', '') }}</h6>
                                        <p class="card-text text-muted small mb-1">
                                            {{ rest['CUISINE DESCRIPTION'] or rest.CUISINE_DESCRIPTION }} | {{ rest.BORO }}
                                        </p>
                                        <p class="card-text text-truncate small mb-0">
                                            {{ rest.BUILDING }} {{ rest.STREET }}
                                        </p>
                                    </div>
                                </div>
                                <div class="col-2 d-flex align-items-center justify-content-center">
                                    <div class="grade-banner rounded-end">
                                        <img src="{{ url_for('static', filename=grade_img_src) }}" alt="NYC Restaurant Grade: {{ grade_val }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center small" role="alert">
                            No restaurants found matching those filters.
                        </div>
                    {% endfor %}
                </div>

            </div>
        </div>
    </div>
    
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasFilters" aria-labelledby="offcanvasFiltersLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasFiltersLabel">Grade Filters</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">

        <h6 class="mt-0 mb-3 text-muted">Filter by Grade</h6>
        <div class="filter-scroll-container mb-4">
            <div class="d-flex filter-no-wrap">
                {# Preserve other filters: cuisine, borough #}
                {% set current_other_params = '&cuisine=' + cuisine if cuisine else '' %}
                {% set current_other_params = current_other_params + ('&borough=' + borough if borough else '') %}
                
                <a href="/restaurants?grade=A{{ current_other_params }}" class="quick-filter-button {% if grade == 'A' %}filter-active{% endif %}">A Grade</a>
                <a href="/restaurants?grade=B{{ current_other_params }}" class="quick-filter-button {% if grade == 'B' %}filter-active{% endif %}">B Grade</a>
                <a href="/restaurants?grade=C{{ current_other_params }}" class="quick-filter-button {% if grade == 'C' %}filter-active{% endif %}">C Grade</a>
                <a href="/restaurants?grade=Z{{ current_other_params }}" class="quick-filter-button {% if grade == 'Z' %}filter-active{% endif %}">Pending/Z</a>
            </div>
        </div>
        
        <div class="d-grid mt-4">
            <a href="/restaurants" class="btn btn-outline-danger">Clear All Filters</a>
        </div>
        
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                if (typeof L === 'undefined') {
                    console.warn('Leaflet not loaded');
                    return;
                }

                const map = L.map('map').setView([40.75, -73.99], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                // Server-provided pins (computed on the server so they use same filters as the restaurant list)
                const serverPins = {{ pins|tojson | safe }} || [];
                // fallbackPins injected from server-side `data` (original row objects)
                const fallbackPins = {{ data|tojson | safe }} || [];

                function getLatLng(obj) {
                    if (!obj) return null;
                    const lat = obj.lat || obj.latitude || obj.LAT || obj.Latitude || (obj.location && obj.location.coordinates && obj.location.coordinates[1]);
                    const lng = obj.lng || obj.longitude || obj.LNG || obj.Longitude || (obj.location && obj.location.coordinates && obj.location.coordinates[0]);
                    if (lat == null || lng == null) return null;
                    return [parseFloat(lat), parseFloat(lng)];
                }

                function addMarker(obj) {
                    const ll = getLatLng(obj);
                    if (!ll) return null;
                    const title = obj.name || obj.DBA || obj.dba || '';
                    const cuisine = obj.cuisine || obj['CUISINE DESCRIPTION'] || obj.CUISINE_DESCRIPTION || '';
                    const grade = obj.grade || obj.GRADE || '';
                    const colorMap = {
                        'A': '#003399',     // Blue (A)
                        'B': '#4B8B3B',     // Green (B)
                        'C': '#B65C2B',     // Brownish orange (C)
                        'Z': '#A0A0A0',     // Gray (Pending)
                        '': '#A0A0A0',
                        'N/A': '#A0A0A0'
                        };

                        const gradeColor = colorMap[grade?.toUpperCase()] || '#A0A0A0';

                        const pinSVG = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                            <path fill="${gradeColor}" stroke="white" stroke-width="2"
                            d="M16 0C9 0 3 6 3 13c0 9 13 19 13 19s13-10 13-19c0-7-6-13-13-13z"/>
                        </svg>
                        `;

                        const icon = L.icon({
                        iconUrl: `data:image/svg+xml;base64,${btoa(pinSVG)}`,
                        iconSize: [26, 40],
                        iconAnchor: [13, 40],
                        popupAnchor: [0, -35]
                        });

                        return L.marker(ll, { icon })
                        .addTo(map)
                        .bindPopup(`
                            <strong><a href="/restaurant/${obj.CAMIS}" target="_blank" style="text-decoration:none;color:#003399;">
                                ${title}
                            </a></strong><br/>
                            Cuisine: ${cuisine}<br/>
                            Grade: ${grade}
                        `);
                }

                // Use serverPins (computed using same filters) if present, otherwise fall back to row data
                (function renderServerPins() {
                    const used = (Array.isArray(serverPins) && serverPins.length) ? serverPins : fallbackPins;
                    const markers = [];
                    used.forEach(p => {
                        const m = addMarker(p);
                        if (m) markers.push(m);
                    });
                    if (markers.length) {
                        const group = L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.2));
                    }
                })();
            });
        </script>
</body>
</html>